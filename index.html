<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>かえる、志賀町ダッシュボード</title>
    
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Annotation Plugin (グラフ用) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    
    <!-- Lucide Icons (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F8FAFC; /* slate-50 */
            color: #1F2937; /* gray-800 */
        }
        .shika-gradient {
            background: linear-gradient(135deg, #0088CE, #00A756);
        }
        .chart-container {
            position: relative;
            height: 400px; /* 少し高さを確保 */
            width: 100%;
        }
        /* トランジション */
        .btn-transition {
            transition: all 0.2s ease-in-out;
        }
        /* Nav Tab Styles - 幅を固定し、丸みを帯びたデザインに統一 */
        .nav-tab {
            @apply w-28 py-2.5 text-sm font-medium rounded-full transition-all whitespace-nowrap border text-center flex-shrink-0;
        }
        .nav-tab.active {
            @apply text-white shadow-md font-bold border-transparent;
            background: linear-gradient(135deg, #0088CE, #00A756);
        }
        .nav-tab.inactive {
            @apply bg-white text-gray-500 border-gray-200 hover:bg-gray-50 hover:text-gray-700;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 py-4 md:h-20 flex flex-col md:flex-row items-center justify-between gap-4">
            <!-- Logo area -->
            <div class="flex items-center gap-2 self-start md:self-auto">
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-gray-800">
                    かえる、志賀町
                </h1>
            </div>

            <!-- Navigation Tabs -->
            <!-- flex-nowrap と overflow-x-auto でスマホでも横スクロール可能にしつつ、各ボタンの幅を維持 -->
            <nav class="flex w-full md:w-auto overflow-x-auto gap-3 no-scrollbar pb-2 md:pb-0 px-1 md:px-0">
                <button class="nav-tab active">人口</button>
                <button class="nav-tab inactive">観光</button>
                <button class="nav-tab inactive">漁業</button>
            </nav>

            <!-- Date Label -->
            <div id="latest-date" class="text-xs text-gray-400 self-end md:self-auto hidden md:block">
                <!-- 日付はJSで挿入 -->
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6 space-y-6 pb-12">
        
        <!-- Mobile Date Label (moved here for better mobile layout) -->
        <div class="md:hidden text-right text-xs text-gray-400 -mt-2 mb-2">
            <span id="latest-date-mobile"></span>
        </div>

        <!-- Intro -->
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-blue-500"></i>
                人口・人流モニタリング
            </h2>
            <p class="text-gray-500 text-sm leading-relaxed mt-1">
                志賀町の人口推移と人の流れ（転入・転出）を可視化しました。
                データの変化から復旧・復興の現状を読み解きます。
            </p>
        </div>

        <!-- Controls: Time Range -->
        <div class="flex justify-center md:justify-end gap-2" id="filter-buttons">
            <button data-range="all" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium btn-transition bg-blue-600 text-white shadow-md">
                全期間
            </button>
            <button data-range="post-quake" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium btn-transition bg-white text-gray-500 border border-gray-200 hover:bg-gray-50">
                震災後 (2024.1~)
            </button>
            <button data-range="1year" class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium btn-transition bg-white text-gray-500 border border-gray-200 hover:bg-gray-50">
                直近1年
            </button>
        </div>

        <!-- KPIs: Population Comparison Focus -->
        <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 opacity-0 transition-opacity duration-500">
            
            <!-- 1. Latest Population -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-green-50 rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                <div>
                    <span class="text-xs text-gray-500 font-bold uppercase tracking-wider flex items-center gap-1">
                        <i data-lucide="users" class="w-3 h-3"></i> 総人口 (最新)
                    </span>
                    <div class="mt-3 flex items-baseline gap-1">
                        <span class="text-4xl font-bold text-gray-800" id="val-total">---</span>
                        <span class="text-sm text-gray-500">人</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-400 text-right relative z-10">
                    最新集計データ
                </div>
            </div>

            <!-- 2. vs Dec 2023 (Pre-Quake) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                <div>
                    <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">震災前比較 (2023.12)</span>
                    <div class="mt-3">
                        <div class="flex items-baseline gap-2">
                            <span id="diff-2023" class="text-3xl font-bold tracking-tight">---</span>
                            <span class="text-sm font-medium text-gray-500">人</span>
                        </div>
                        <div class="mt-1 flex items-center gap-2">
                            <span id="rate-2023" class="text-xs font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">---%</span>
                            <span class="text-xs text-gray-400">(基準: <span id="ref-2023">---</span>人)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. vs Dec 2015 (Long Term) -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-orange-50 rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                <div>
                    <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">長期比較 (2015.12)</span>
                    <div class="mt-3">
                        <div class="flex items-baseline gap-2">
                            <span id="diff-2015" class="text-3xl font-bold tracking-tight">---</span>
                            <span class="text-sm font-medium text-gray-500">人</span>
                        </div>
                        <div class="mt-1 flex items-center gap-2">
                            <span id="rate-2015" class="text-xs font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">---%</span>
                            <span class="text-xs text-gray-400">(基準: <span id="ref-2015">---</span>人)</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-[#00A756] rounded-full animate-spin"></div>
            <p class="text-gray-400 text-sm mt-4">データを読み込んでいます...</p>
        </div>

        <!-- Error Message (Initially Hidden) -->
        <div id="error-message" class="hidden flex-col items-center justify-center py-10 text-center">
            <i data-lucide="alert-circle" class="w-10 h-10 text-red-400 mb-2"></i>
            <p class="text-gray-600 font-bold">データの読み込みに失敗しました</p>
            <p class="text-gray-400 text-sm mt-1">通信環境を確認するか、時間をおいて再読み込みしてください。</p>
        </div>

        <!-- Charts Area (Hidden until loaded) -->
        <div id="dashboard-content" class="space-y-6 hidden">
            
            <!-- Chart 1: Population (2-Axis) -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                    <h3 class="font-bold text-gray-700">人口推移 (総数・男女2軸)</h3>
                </div>
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="popChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Chart 2: Migration (Gender Breakdown) -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="arrow-right-left" class="w-5 h-5 text-gray-400"></i>
                        <div>
                            <h3 class="font-bold text-gray-700">転入・転出の推移 (男女別)</h3>
                            <p class="text-xs text-gray-400 font-normal">棒グラフ：純移動、青系：転入(男/女)、橙系：転出(男/女)</p>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="migrationChart"></canvas>
                    </div>
                </div>
            </section>

            <footer class="text-center text-gray-400 text-xs py-8">
                <p class="mb-2">© 2024 Kaeru Shika Dashboard Prototype</p>
                <div class="flex justify-center gap-4">
                    <span>Powered by Chart.js</span>
                    <span>Data: shika_population.csv</span>
                </div>
            </footer>
        </div>
    </main>

    <script>
        // --- 設定・定数 ---
        const COLORS = {
            blue: '#0088CE',
            green: '#00A756',
            orange: '#F39800',
            red: '#EF4444',
            maleBlue: '#1e40af', // 濃い青
            femaleBlue: '#60a5fa', // 薄い青
            maleOrange: '#ea580c', // 濃いオレンジ
            femaleOrange: '#fb923c', // 薄いオレンジ
            netPositive: 'rgba(134, 239, 172, 0.4)', // #86EFAC
            netNegative: 'rgba(252, 165, 165, 0.4)', // #FCA5A5
            bgArea: 'rgba(0, 167, 86, 0.05)'
        };

        // RAW_DATA は削除し、fetch で取得します

        // グローバル変数
        let allData = [];
        let chartPop = null;
        let chartMigration = null;

        // --- データ処理 ---
        function parseData(rawData) {
            const lines = rawData.trim().split('\n');
            const dataMap = new Map();

            lines.forEach((line, index) => {
                if (index === 0) return; // ヘッダー
                
                // 行が空の場合はスキップ
                if (!line.trim()) return;

                let parts;
                // CSV(カンマ区切り)か、TSV/SSV(空白区切り)かを簡易判定
                if (line.indexOf(',') !== -1) {
                    parts = line.trim().split(',');
                } else {
                    parts = line.trim().split(/\s+/);
                }

                if (parts.length < 5) return;

                const yearMonthStr = parts[0].trim();
                const gender = parts[1].trim();
                const year = yearMonthStr.substring(0, 4);
                const month = yearMonthStr.substring(4, 6);
                const formattedDate = `${year}-${month}`;

                // Values at end
                const len = parts.length;
                const parseNum = (str) => {
                    if (!str) return 0;
                    return parseInt(str.trim().replace(/,/g, ''), 10) || 0;
                };

                const popEnd = parseNum(parts[len - 2]);
                const moveOut = parseNum(parts[len - 3]);
                const moveIn = parseNum(parts[len - 4]);

                if (!dataMap.has(formattedDate)) {
                    dataMap.set(formattedDate, {
                        date: formattedDate,
                        displayDate: `${year}年${month}月`,
                        totalPop: 0,
                        malePop: 0,
                        femalePop: 0,
                        moveIn: 0,
                        moveOut: 0,
                        netMigration: 0,
                        // 男女別転入出初期化
                        maleMoveIn: 0,
                        femaleMoveIn: 0,
                        maleMoveOut: 0,
                        femaleMoveOut: 0,
                    });
                }

                const entry = dataMap.get(formattedDate);

                if (gender === '男') {
                    entry.malePop = popEnd;
                    entry.maleMoveIn = moveIn;
                    entry.maleMoveOut = moveOut;
                } else if (gender === '女') {
                    entry.femalePop = popEnd;
                    entry.femaleMoveIn = moveIn;
                    entry.femaleMoveOut = moveOut;
                }
                
                entry.totalPop += popEnd;
                entry.moveIn += moveIn;
                entry.moveOut += moveOut;
                
                entry.netMigration = entry.moveIn - entry.moveOut;
            });

            return Array.from(dataMap.values()).sort((a, b) => a.date.localeCompare(b.date));
        }

        // --- 画面描画 ---
        function updateDashboard(rangeType) {
            // フィルタリング
            let filtered = [];
            if (rangeType === 'post-quake') {
                filtered = allData.filter(d => d.date >= '2024-01');
            } else if (rangeType === '1year') {
                filtered = allData.slice(-12);
            } else {
                filtered = [...allData];
            }

            if (filtered.length === 0) return;

            // --- KPI計算 (総人口比較) ---
            // 最新データ (フィルタリング結果の最後)
            const latest = filtered[filtered.length - 1];
            
            // 比較対象データ (全期間データから探索)
            const preQuake = allData.find(d => d.date === '2023-12');
            const tenYear = allData.find(d => d.date === '2015-12');

            // 1. 最新更新
            // ヘッダー（デスクトップ）
            const headerDate = document.getElementById('latest-date');
            if (headerDate) headerDate.textContent = `${latest.displayDate} 現在`;
            
            // モバイル用（追加した要素）
            const mobileDate = document.getElementById('latest-date-mobile');
            if (mobileDate) mobileDate.textContent = `${latest.displayDate} 現在`;

            document.getElementById('val-total').textContent = latest.totalPop.toLocaleString();

            // 2. 震災前比較 (2023.12)
            if (preQuake) {
                document.getElementById('ref-2023').textContent = preQuake.totalPop.toLocaleString();
                
                const diff = latest.totalPop - preQuake.totalPop;
                const sign = diff > 0 ? '+' : '';
                document.getElementById('diff-2023').textContent = `${sign}${diff.toLocaleString()}`;
                document.getElementById('diff-2023').className = `text-3xl font-bold tracking-tight ${diff >= 0 ? 'text-green-600' : 'text-red-500'}`;

                const rate = (diff / preQuake.totalPop) * 100;
                document.getElementById('rate-2023').textContent = `${sign}${rate.toFixed(1)}%`;
            }

            // 3. 長期比較 (2015.12)
            if (tenYear) {
                document.getElementById('ref-2015').textContent = tenYear.totalPop.toLocaleString();
                
                const diff = latest.totalPop - tenYear.totalPop;
                const sign = diff > 0 ? '+' : '';
                document.getElementById('diff-2015').textContent = `${sign}${diff.toLocaleString()}`;
                document.getElementById('diff-2015').className = `text-3xl font-bold tracking-tight ${diff >= 0 ? 'text-green-600' : 'text-red-500'}`;

                const rate = (diff / tenYear.totalPop) * 100;
                document.getElementById('rate-2015').textContent = `${sign}${rate.toFixed(1)}%`;
            }

            // --- チャート更新 ---
            updatePopChart(filtered);
            updateMigrationChart(filtered);
        }

        // --- Chart.js 設定共通 ---
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        font: { family: "'Noto Sans JP', sans-serif", size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#374151',
                    bodyColor: '#4B5563',
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    padding: 10,
                    titleFont: { family: "'Noto Sans JP', sans-serif", size: 13, weight: 'bold' },
                    bodyFont: { family: "'Noto Sans JP', sans-serif", size: 12 },
                    displayColors: true,
                    boxPadding: 4
                },
                annotation: {
                    annotations: {
                        quakeLine: {
                            type: 'line',
                            scaleID: 'x',
                            value: '2024年01月', // ラベルと一致させる
                            borderColor: COLORS.red,
                            borderWidth: 2,
                            borderDash: [4, 4],
                            label: {
                                display: true,
                                content: '震災',
                                position: 'start',
                                backgroundColor: COLORS.red,
                                color: 'white',
                                font: { size: 10 },
                                yAdjust: 10
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 10 },
                        maxTicksLimit: 12,
                        color: '#9CA3AF'
                    }
                },
                y: {
                    border: { display: false },
                    grid: { color: '#F3F4F6' },
                    ticks: {
                        font: { size: 10 },
                        color: '#9CA3AF'
                    }
                }
            }
        };

        function updatePopChart(data) {
            const ctx = document.getElementById('popChart').getContext('2d');
            const labels = data.map(d => d.displayDate);

            // 震災ラインを表示するか判定
            const showAnnotation = data.some(d => d.displayDate === '2024年01月');
            const options = JSON.parse(JSON.stringify(commonOptions)); // Deep copy
            
            // 2軸設定の追加
            options.scales.y = {
                type: 'linear',
                display: true,
                position: 'left',
                grid: { color: '#F3F4F6' },
                title: { display: true, text: '総人口', color: COLORS.green }
            };
            options.scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                grid: { drawOnChartArea: false }, // グリッド重複防止
                title: { display: true, text: '男女別', color: COLORS.blue }
            };

            if (!showAnnotation) options.plugins.annotation = {};

            if (chartPop) {
                chartPop.destroy();
            }

            chartPop = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '総人口 (左軸)',
                            data: data.map(d => d.totalPop),
                            borderColor: COLORS.green,
                            backgroundColor: COLORS.bgArea,
                            borderWidth: 3,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: '男性 (右軸)',
                            data: data.map(d => d.malePop),
                            borderColor: COLORS.blue,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        },
                        {
                            label: '女性 (右軸)',
                            data: data.map(d => d.femalePop),
                            borderColor: COLORS.orange,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: options
            });
        }

        function updateMigrationChart(data) {
            const ctx = document.getElementById('migrationChart').getContext('2d');
            const labels = data.map(d => d.displayDate);

            const showAnnotation = data.some(d => d.displayDate === '2024年01月');
            const options = JSON.parse(JSON.stringify(commonOptions));
            if (!showAnnotation) options.plugins.annotation = {};

            if (chartMigration) {
                chartMigration.destroy();
            }

            chartMigration = new Chart(ctx, {
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: '純移動',
                            data: data.map(d => d.netMigration),
                            backgroundColor: data.map(d => d.netMigration >= 0 ? COLORS.netPositive : COLORS.netNegative),
                            borderColor: 'transparent',
                            barPercentage: 0.6,
                            order: 3
                        },
                        // 男性 転入
                        {
                            type: 'line',
                            label: '男性転入',
                            data: data.map(d => d.maleMoveIn),
                            borderColor: COLORS.maleBlue,
                            backgroundColor: COLORS.maleBlue,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3,
                            order: 1
                        },
                        // 女性 転入
                        {
                            type: 'line',
                            label: '女性転入',
                            data: data.map(d => d.femaleMoveIn),
                            borderColor: COLORS.femaleBlue,
                            backgroundColor: COLORS.femaleBlue,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3,
                            order: 1
                        },
                         // 男性 転出
                         {
                            type: 'line',
                            label: '男性転出',
                            data: data.map(d => d.maleMoveOut),
                            borderColor: COLORS.maleOrange,
                            backgroundColor: COLORS.maleOrange,
                            borderWidth: 2,
                            borderDash: [2, 2], // 転出は点線気味に
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3,
                            order: 2
                        },
                        // 女性 転出
                        {
                            type: 'line',
                            label: '女性転出',
                            data: data.map(d => d.femaleMoveOut),
                            borderColor: COLORS.femaleOrange,
                            backgroundColor: COLORS.femaleOrange,
                            borderWidth: 2,
                            borderDash: [2, 2], // 転出は点線気味に
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3,
                            order: 2
                        }
                    ]
                },
                options: options
            });
        }

        // --- 初期化 ---
        window.addEventListener('DOMContentLoaded', () => {
            // CSV Fetch
            fetch('./shika_population.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    allData = parseData(text);
                    
                    // ローディング消去
                    document.getElementById('loading').classList.add('hidden');
                    
                    // データが空でなければコンテンツ表示
                    if (allData.length > 0) {
                        const content = document.getElementById('dashboard-content');
                        content.classList.remove('hidden');
                        
                        const kpi = document.getElementById('kpi-container');
                        kpi.classList.remove('opacity-0');

                        // 初期描画
                        updateDashboard('all');
                        
                        // アイコン
                        if (window.lucide) lucide.createIcons();
                    } else {
                        // データパース失敗時などはエラー扱い
                        throw new Error('Data parsing resulted in empty dataset');
                    }
                })
                .catch(error => {
                    console.error('Data loading failed:', error);
                    document.getElementById('loading').classList.add('hidden');
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.add('flex');
                    if (window.lucide) lucide.createIcons();
                });

            // ボタンイベント
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // スタイル更新
                    buttons.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                        b.classList.add('bg-white', 'text-gray-500', 'border', 'border-gray-200');
                    });
                    e.target.classList.remove('bg-white', 'text-gray-500', 'border', 'border-gray-200');
                    e.target.classList.add('bg-blue-600', 'text-white', 'shadow-md');

                    // データ更新
                    updateDashboard(e.target.dataset.range);
                });
            });
        });

    </script>
</body>
</html>
